<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OAK Invoicing — Modern Excel-Based Tool</title>
  
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- SheetJS for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Google API Client for Drive -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    // Configuration for Tailwind CSS Dark Mode and Custom Theme
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            accent: {
              DEFAULT: '#b8860b',
              light: '#d4ac0d',
              dark: '#9c6f09'
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Custom styles for a polished look */
    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    #print-stamp { display: none; }
    /* Print-specific styles - Ultra Compact */
    @media print {
      body {
        background-color: white !important;
        font-size: 8pt;
        margin: 0;
        padding: 0.15in 0.25in;
      }
      .no-print { display: none !important; }
      .print-only-flex { display: flex !important; }
      .print-only-block { display: block !important; }
      .print-shadow-none { box-shadow: none !important; }
      .print-border-none { border: none !important; }
      .print-p-0 { padding: 0 !important; }
      .print-w-full { width: 100% !important; }
      .print-max-w-none { max-width: none !important; }
      .print-m-0 { margin: 0 !important; }
      input, textarea, select {
        border-color: transparent !important;
        background-color: white !important;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding: 0 !important;
        color: black !important;
        font-size: 8pt;
        line-height: 1.2;
      }
      textarea {
        resize: none !important;
        min-height: auto !important;
        height: auto !important;
      }
      #app-card {
        border-radius: 0;
        position: relative;
        box-shadow: none;
        padding: 0 !important;
        margin: 0 !important;
      }
      #print-stamp {
        display: block;
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        border: 6px solid;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        font-size: 4rem;
        font-weight: 800;
        letter-spacing: 0.15em;
        opacity: 0.12;
        user-select: none;
        z-index: 10;
      }
      .print-bg-transparent { background-color: transparent !important; }
      tr, .totals-section > div {
        page-break-inside: avoid;
      }
      /* Ultra compact table spacing */
      table th, table td {
        padding: 0.1rem 0.2rem !important;
        font-size: 7.5pt;
        line-height: 1.15;
      }
      table thead th {
        font-size: 7pt;
        padding: 0.1rem 0.2rem !important;
        text-transform: uppercase;
      }
      /* Minimize ALL spacing */
      section {
        margin-top: 0.15rem !important;
        margin-bottom: 0.15rem !important;
      }
      h1 {
        font-size: 12pt !important;
        margin: 0.1rem 0 !important;
      }
      h2 {
        font-size: 10pt !important;
        margin: 0.1rem 0 !important;
      }
      h3 {
        font-size: 8pt !important;
        margin: 0.1rem 0 !important;
        font-weight: 600;
      }
      /* Force attachments to be visible */
      #attachments {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      #attachments > div {
        display: inline-flex !important;
        margin-right: 0.5rem !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
        background: transparent !important;
        font-size: 7pt;
      }
      /* Compact logo and header */
      #print-logo {
        max-height: 32px !important;
        max-width: 32px !important;
      }
      /* Print header compact layout */
      .print-header-row {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
      }
      /* Grid layout - side by side for print */
      .lg\:grid-cols-2 {
        display: flex !important;
        gap: 1rem !important;
      }
      .lg\:grid-cols-2 > * {
        flex: 1 !important;
        margin-bottom: 0 !important;
      }
      /* Bill to and details inline */
      #billTo {
        font-size: 7.5pt !important;
        line-height: 1.2 !important;
        min-height: 50px !important;
      }
      /* Notes section compact */
      #notes {
        font-size: 7.5pt !important;
        line-height: 1.2 !important;
        min-height: 30px !important;
      }
      /* Totals section compact */
      .totals-section {
        font-size: 8pt !important;
      }
      .totals-section > div {
        padding: 0.1rem 0 !important;
      }
      /* Footer compact */
      .print-footer {
        margin-top: 0.5rem !important;
        padding-top: 0.25rem !important;
        font-size: 7pt !important;
      }
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Responsive Table for Mobile */
    @media (max-width: 768px) {
      #items thead {
        display: none;
      }
      #items tr {
        display: block;
        width: 100%;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .dark #items tr {
        border-color: #334155;
      }
      #items td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        text-align: right;
        padding: 0.5rem 0;
        border-bottom: 1px dashed #e2e8f0;
      }
      .dark #items td {
        border-color: #334155;
      }
      #items td:last-child {
        border-bottom: none;
        padding-top: 0.75rem;
        justify-content: flex-end;
      }
      #items td[data-label]::before {
        content: attr(data-label);
        font-weight: 600;
        color: #64748b;
        text-align: left;
      }
      .dark #items td[data-label]::before {
          color: #94a3b8;
      }
      #items td:first-child {
        display: block;
        text-align: left;
        padding-bottom: 0.75rem;
      }
      #items td:first-child::before {
        display: none;
      }
      #items td input[type="number"] {
        max-width: 120px;
        text-align: right;
      }
    }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans transition-colors duration-300">

  <!-- Main container -->
  <div id="main-container" class="max-w-5xl mx-auto p-4 md:p-8 print-max-w-none print-m-0 transition-all duration-300">
    <div id="app-card" data-print-status="" class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg print-shadow-none transition-colors duration-300 relative overflow-hidden">
      
      <!-- STATUS Stamp for Print -->
      <div id="print-stamp">STAMP</div>
      
      <div class="p-6 md:p-8 print-p-0">
        
        <!-- START: Print-Only Header - Ultra Compact -->
        <div class="hidden print-only-flex mb-1 items-center border-b border-gray-300 pb-1" style="font-size: 7pt; justify-content: space-between;">
            <div class="flex items-center gap-1">
                <img id="print-logo" src="" alt="Logo" class="object-contain" style="width: 28px; height: 28px;">
                <div style="line-height: 1.1;">
                    <p class="font-bold text-gray-900" style="font-size: 9pt; margin: 0;" id="print-company-name">OAK Builders LLC</p>
                    <p class="text-gray-600" style="font-size: 6.5pt; margin: 0;"><span id="print-company-phone">(202) 888-9895</span> • <span id="print-company-email">info@oakllc.co</span></p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right" style="font-size: 6.5pt; line-height: 1.1;">
                    <p style="margin: 0;" id="print-company-address">123 Construction Way</p>
                    <p style="margin: 0;"><span id="print-company-city">Fairfax, VA 22030</span> • <span id="print-company-website">www.oakllc.co</span></p>
                </div>
                <div class="text-right" style="border-left: 1px solid #ccc; padding-left: 8px;">
                    <p class="font-bold text-gray-800" style="font-size: 11pt; margin: 0;" id="print-doc-title">INVOICE</p>
                    <p class="text-gray-600" style="font-size: 7pt; margin: 0;">#<span id="print-doc-number"></span></p>
                </div>
            </div>
        </div>
        <!-- END: Print-Only Header -->

        <!-- Google Sign-In Section (shown when not authenticated) -->
        <div id="auth-section" class="no-print pb-6 mb-6 border-b border-slate-200 dark:border-slate-700">
          <div class="flex flex-col items-center justify-center gap-4 p-8 bg-gradient-to-r from-accent/10 to-accent-light/10 dark:from-accent/20 dark:to-accent-light/20 rounded-xl">
            <div class="text-center">
              <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Welcome to OAK Invoicing</h2>
              <p class="text-slate-600 dark:text-slate-400 mb-4">Sign in with Google to access your invoices from any device</p>
            </div>
            <div id="google-signin-button"></div>
            <p class="text-xs text-slate-500 dark:text-slate-400 max-w-md text-center">
              Your invoices will be automatically saved to your Google Drive. Access them from any device, anywhere.
            </p>
          </div>
        </div>

        <!-- User Profile Section (shown when authenticated) -->
        <div id="user-profile" class="hidden no-print pb-4 mb-4 border-b border-slate-200 dark:border-slate-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img id="user-avatar" src="" alt="User" class="w-10 h-10 rounded-full">
              <div>
                <p class="text-sm font-semibold text-slate-900 dark:text-white" id="user-name"></p>
                <p class="text-xs text-slate-500 dark:text-slate-400" id="user-email"></p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div id="sync-status" class="flex items-center gap-2 px-3 py-1.5 bg-green-100 dark:bg-green-900/30 rounded-lg">
                <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-xs font-medium text-green-700 dark:text-green-300" id="sync-text">Synced</span>
              </div>
              <button data-action="signOut" class="px-3 py-1.5 text-xs font-semibold text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors">Sign Out</button>
            </div>
          </div>
        </div>

        <!-- Header Section -->
        <header id="app-header" class="hidden pb-6 border-b border-slate-200 dark:border-slate-700 print-border-none">
          <div class="flex flex-wrap items-center justify-between gap-6">
            <!-- Brand Info -->
            <div class="flex items-center gap-4 no-print">
              <img id="ui-logo" src="https://placehold.co/80x80/b8860b/FFFFFF?text=OAK" alt="Company Logo" class="w-20 h-20 h-auto object-contain bg-slate-100 dark:bg-slate-700 rounded-lg">
              <div>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">OAK Builders LLC</h2>
                <input type="file" id="logoPicker" class="hidden" accept="image/*">
                <button data-action="uploadLogo" class="text-xs font-semibold text-accent dark:text-accent-light hover:underline">Upload Logo</button>
              </div>
            </div>
            <!-- Document Type -->
            <div class="flex items-center gap-3">
              <h1 id="docTitle" class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white print:text-4xl print:text-gray-800">Invoice</h1>
              <select id="docType" class="no-print bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm focus:ring-accent focus:border-accent"></select>
            </div>
          </div>
          
          <!-- Toolbar -->
          <div class="no-print mt-6 flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-2 flex-wrap">
                <input id="filePicker" type="file" accept=".xlsx" class="hidden" />

                <!-- Template Selector -->
                <div class="flex items-center gap-2">
                  <label for="templateSelect" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Template:</label>
                  <select id="templateSelect" class="bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm px-3 py-2 focus:ring-accent focus:border-accent">
                    <option value="">None</option>
                    <option value="standard">Standard Invoice</option>
                    <option value="construction">Construction Project</option>
                    <option value="quickEstimate">Quick Estimate</option>
                    <option value="maintenance">Maintenance Service</option>
                  </select>
                </div>

                <div class="h-6 w-px bg-slate-300 dark:bg-slate-600"></div>

                <button data-action="openRepository" class="px-4 py-2 text-sm font-semibold bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700 rounded-lg transition-all">
                  <svg class="inline w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                  Repository
                </button>

                <div class="h-6 w-px bg-slate-300 dark:bg-slate-600"></div>

                <button data-action="loadFromDrive" class="px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">
                  <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/></svg>
                  Load from Drive
                </button>
                <button data-action="saveToDrive" class="px-4 py-2 text-sm font-semibold text-white bg-accent hover:bg-accent-light rounded-lg transition-colors">
                  <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/></svg>
                  Save to Drive
                </button>
                <button data-action="loadExcel" class="px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Load Local Excel</button>
                <button data-action="saveExcel" class="px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Save Local Excel</button>
                <button data-action="emailInvoice" class="px-4 py-2 text-sm font-semibold bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800 rounded-lg transition-colors">
                  <svg class="inline w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email Invoice
                </button>
              </div>
              <div class="flex items-center gap-2">
                 <div class="flex items-center gap-2">
                    <label for="stampType" class="text-xs font-semibold text-slate-500">PDF Stamp</label>
                    <select id="stampType" class="bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm focus:ring-accent focus:border-accent"></select>
                 </div>
                 <button onclick="window.print()" class="px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Print / PDF</button>
                 <button data-action="openSettings" class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors" title="Company Settings">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                 </button>
                 <button id="theme-toggle" data-action="toggleTheme" class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <svg id="theme-icon-light" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                 </button>
              </div>
          </div>
        </header>

        <!-- Company Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 no-print">
          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Company Settings</h2>
              <button data-action="closeSettings" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
            </div>
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Company Name</label>
                  <input id="settings-name" type="text" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Address</label>
                  <input id="settings-address" type="text" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">City, State, ZIP</label>
                  <input id="settings-city" type="text" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email</label>
                  <input id="settings-email" type="email" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Phone</label>
                  <input id="settings-phone" type="tel" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Website</label>
                  <input id="settings-website" type="url" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Zelle</label>
                  <input id="settings-zelle" type="text" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Venmo</label>
                  <input id="settings-venmo" type="text" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Payment Terms</label>
                  <textarea id="settings-terms" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2 min-h-[80px]"></textarea>
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Default Notes</label>
                  <textarea id="settings-notes" class="w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent p-2"></textarea>
                </div>
              </div>
            </div>
            <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
              <button data-action="closeSettings" class="px-4 py-2 text-sm font-semibold text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors">Cancel</button>
              <button data-action="saveSettings" class="px-4 py-2 text-sm font-semibold text-white bg-accent hover:bg-accent-light rounded-lg transition-colors">Save Settings</button>
            </div>
          </div>
        </div>

        <!-- Repository Modal -->
        <div id="repository-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 no-print">
          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Invoice & Estimate Repository</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Browse and manage all your documents</p>
              </div>
              <div class="flex items-center gap-2">
                <button data-action="refreshRepository" class="px-3 py-1.5 text-sm font-semibold text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors">
                  <svg class="inline w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                  Refresh
                </button>
                <button data-action="closeRepository" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                  <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
              </div>
            </div>
            <!-- Filters -->
            <div class="px-4 py-3 bg-slate-50 dark:bg-slate-700/30 border-b border-slate-200 dark:border-slate-700 flex flex-wrap gap-3 items-center">
              <select id="repo-filter-type" class="bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm px-3 py-1.5">
                <option value="">All Types</option>
                <option value="Invoice">Invoices</option>
                <option value="Estimate">Estimates</option>
              </select>
              <select id="repo-filter-status" class="bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm px-3 py-1.5">
                <option value="">All Statuses</option>
                <option value="Draft">Draft</option>
                <option value="Sent">Sent</option>
                <option value="Approved">Approved</option>
                <option value="Paid">Paid</option>
                <option value="Rejected">Rejected</option>
              </select>
              <input id="repo-search" type="text" placeholder="Search by number or client..." class="flex-1 min-w-[200px] bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg text-sm px-3 py-1.5">
              <div id="repo-stats" class="text-sm text-slate-500 dark:text-slate-400 ml-auto"></div>
            </div>
            <!-- Repository Table -->
            <div class="flex-1 overflow-y-auto p-4">
              <div id="repository-loading" class="hidden flex items-center justify-center py-12">
                <svg class="animate-spin h-8 w-8 text-accent" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-slate-500">Loading repository...</span>
              </div>
              <div id="repository-empty" class="hidden text-center py-12">
                <svg class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <p class="text-slate-500 dark:text-slate-400">No documents found</p>
                <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Create a new invoice or estimate to get started</p>
              </div>
              <table id="repository-table" class="hidden w-full">
                <thead class="bg-slate-100 dark:bg-slate-700/50 text-xs uppercase text-slate-500 dark:text-slate-400 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold">Type</th>
                    <th class="px-3 py-2 text-left font-semibold">Number</th>
                    <th class="px-3 py-2 text-left font-semibold">Client</th>
                    <th class="px-3 py-2 text-left font-semibold">Date</th>
                    <th class="px-3 py-2 text-right font-semibold">Total</th>
                    <th class="px-3 py-2 text-center font-semibold">Status</th>
                    <th class="px-3 py-2 text-center font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="repository-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
              </table>
            </div>
            <!-- Summary Footer -->
            <div id="repository-summary" class="px-4 py-3 bg-slate-50 dark:bg-slate-700/30 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-sm">
              <div class="flex gap-6">
                <span class="text-slate-500 dark:text-slate-400">Total Invoiced: <strong id="repo-total-invoiced" class="text-slate-700 dark:text-slate-200">$0.00</strong></span>
                <span class="text-slate-500 dark:text-slate-400">Total Paid: <strong id="repo-total-paid" class="text-green-600 dark:text-green-400">$0.00</strong></span>
                <span class="text-slate-500 dark:text-slate-400">Outstanding: <strong id="repo-total-outstanding" class="text-accent">$0.00</strong></span>
              </div>
              <button data-action="newDocument" class="px-4 py-2 text-sm font-semibold text-white bg-accent hover:bg-accent-light rounded-lg transition-colors">+ New Document</button>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="hidden mt-8">
          <div class="flex flex-col md:flex-row justify-between gap-8">
              
              <!-- Bill To Section -->
              <section class="w-full md:w-1/2">
                <label for="billTo" class="text-xs font-semibold text-slate-500 dark:text-slate-400 print:text-gray-500">Bill to</label>
                <textarea id="billTo" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent min-h-[110px]" placeholder="Client name&#10;Company&#10;Email · Phone&#10;Address"></textarea>
              </section>

              <!-- Details Section -->
              <section class="w-full md:w-1/2">
                <!-- Print Details Table -->
                <table class="w-full hidden print-only-block mb-8">
                    <tbody>
                        <tr class="border-b border-gray-200"><td class="py-1 pr-4 text-gray-500">Invoice #</td><td id="printInvNo" class="py-1 font-semibold text-gray-800 text-right"></td></tr>
                        <tr class="border-b border-gray-200"><td class="py-1 pr-4 text-gray-500">Date</td><td id="printInvDate" class="py-1 font-semibold text-gray-800 text-right"></td></tr>
                        <tr id="printDueWrap" class="border-b border-gray-200"><td class="py-1 pr-4 text-gray-500">Due Date</td><td id="printDueDate" class="py-1 font-semibold text-gray-800 text-right"></td></tr>
                    </tbody>
                </table>
                  
                <!-- Interactive Form -->
                <div class="grid grid-cols-2 gap-6 no-print">
                    <div>
                      <label for="invNo" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Invoice / Estimate #</label>
                      <input id="invNo" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent" placeholder="e.g., 0001" />
                    </div>
                     <div>
                      <label for="status" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Status</label>
                      <select id="status" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent"></select>
                    </div>
                    <div>
                      <label for="invDate" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Date</label>
                      <input id="invDate" type="date" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent" />
                    </div>
                    <div id="dueWrap">
                      <label for="dueIn" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Due Date</label>
                      <select id="dueIn" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent"></select>
                    </div>
                    <div id="paidWrap" class="col-span-2">
                      <div class="flex items-center justify-between">
                        <label for="paid" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Amount Paid</label>
                        <button data-action="togglePayments" class="no-print text-xs font-semibold text-accent dark:text-accent-light">Track Payments</button>
                      </div>
                      <input id="paid" type="text" value="$0.00" class="mt-1 block w-full bg-slate-50 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm" readonly />
                      <div id="paymentTracker" class="no-print hidden mt-2 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg"></div>
                    </div>
                </div>
                 <div class="no-print">
                     <label for="recId" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Record ID</label>
                     <input id="recId" class="mt-1 block w-full bg-slate-50 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm" placeholder="Auto-generated" readonly />
                 </div>
              </section>
          </div>

          <!-- Items Table -->
          <section class="mt-10">
            <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700 print-border-none md:border-0 md:rounded-none">
              <table class="w-full" id="items">
                <thead class="bg-slate-50 dark:bg-slate-700/50 text-xs uppercase text-slate-500 dark:text-slate-400 print:bg-gray-100 print:text-gray-700">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold print:px-2 print:py-1 print:text-xs">Item</th>
                    <th class="px-4 py-3 text-right font-semibold w-24 print:px-2 print:py-1 print:w-16 print:text-xs">Qty</th>
                    <th class="px-4 py-3 text-right font-semibold w-32 print:px-2 print:py-1 print:w-20 print:text-xs">Rate</th>
                    <th class="px-4 py-3 text-right font-semibold w-32 print:px-2 print:py-1 print:w-20 print:text-xs">Amount</th>
                    <th class="px-4 py-3 text-center font-semibold w-12 no-print"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="no-print mt-4 flex items-center gap-2">
              <button data-action="addRow" class="px-3 py-1.5 text-sm font-semibold bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md transition-colors">+ Add Item</button>
              <button data-action="clearAll" class="px-3 py-1.5 text-sm font-semibold text-red-700 dark:text-red-400 bg-red-100 dark:bg-red-900/50 hover:bg-red-200 dark:hover:bg-red-900/80 rounded-md transition-colors">Clear All</button>
            </div>
          </section>

          <!-- Notes, Attachments, and Totals -->
          <section class="mt-10 grid lg:grid-cols-2 gap-12 print:grid-cols-1 print:gap-4">
            <div>
              <div>
                <label for="notes" class="text-xs font-semibold text-slate-500 dark:text-slate-400 print:text-gray-500">Notes</label>
                <textarea id="notes" class="mt-1 block w-full bg-white dark:bg-slate-900/50 border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:ring-accent focus:border-accent" placeholder="Thanks for your business."></textarea>
              </div>
              <div class="mt-6 print:mt-3">
                <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300 print:text-gray-900 print:text-xs print:mb-1">Attachments</h3>
                <div class="mt-2 print:mt-1">
                  <input id="attachPicker" type="file" multiple class="no-print block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent/10 file:text-accent-dark dark:file:bg-accent/20 dark:file:text-accent-light hover:file:bg-accent/20"/>
                  <div id="attachments" class="mt-3 space-y-2 print:mt-1 print:space-y-1"></div>
                  <p class="no-print mt-2 text-xs text-slate-500 dark:text-slate-400">Large files will increase workbook size. PDFs are recommended.</p>
                </div>
                <div id="attachments" class="mt-3 space-y-2"></div>
              </div>
            </div>
            <!-- Totals Section -->
            <div class="space-y-4 totals-section">
               <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500 dark:text-slate-400 print:text-gray-600">Subtotal</span>
                        <span id="subtotal" class="font-semibold text-slate-700 dark:text-slate-200 print:text-gray-800">$0.00</span>
                    </div>

                    <!-- Dynamic Adjustments: Bond, OH, Profit -->
                    <div id="adjustments"></div>

                    <div class="flex justify-between items-center">
                      <div class="flex items-center gap-2">
                        <span class="text-slate-500 dark:text-slate-400 print:text-gray-600">Tax</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <input id="taxRate" type="number" min="0" step="0.01" value="0" class="w-20 text-right bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md text-sm focus:ring-accent focus:border-accent no-print">
                        <span class="text-slate-500 dark:text-slate-400 print:text-gray-600" id="printTaxRate">0%</span>
                      </div>
                    </div>
                     <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-500 dark:text-slate-400 pl-4 print:text-gray-600">Tax amount</span>
                        <span id="tax" class="font-medium text-slate-600 dark:text-slate-300 print:text-gray-800">$0.00</span>
                    </div>
                </div>

                <div class="border-t border-slate-200 dark:border-slate-700 pt-4 space-y-3">
                    <div class="flex justify-between items-center text-lg font-bold">
                        <span class="text-slate-800 dark:text-white print:text-gray-800">Total</span>
                        <span id="total" class="text-slate-800 dark:text-white print:text-gray-800">$0.00</span>
                    </div>
                     <div class="flex justify-between items-center font-semibold">
                        <span class="text-slate-500 dark:text-slate-400 print:text-gray-600">Amount Paid</span>
                        <span id="paidTotal" class="text-slate-700 dark:text-slate-200 print:text-gray-800">$0.00</span>
                    </div>
                    <div id="balanceRow" class="flex justify-between items-center font-semibold text-accent-dark dark:text-accent-light print:bg-yellow-100 print:p-2 print:rounded-md">
                        <span class="print:text-yellow-800">Balance Due</span>
                        <span id="due" class="print:text-yellow-800">$0.00</span>
                    </div>
                </div>
            </div>
          </section>

        </main>
        
        <!-- START: Print-Only Footer - Compact -->
        <div class="hidden print-only-block mt-4 pt-2 border-t border-gray-200 print-footer" style="font-size: 6.5pt; color: #555;">
            <div style="display: flex; justify-content: space-between; gap: 1rem;">
                <div style="flex: 2;">
                    <strong style="font-size: 7pt;">Payment Terms:</strong>
                    <span id="paymentTerms">Payment is due upon receipt. Late payments are subject to a service charge of 1.5% per month.</span>
                </div>
                <div style="flex: 1; text-align: right;">
                    <strong style="font-size: 7pt;">Payment Methods:</strong>
                    <span id="print-payment-zelle">Zelle: payments@oakllc.co</span> |
                    <span id="print-payment-venmo">Venmo: @oak-builders</span>
                </div>
            </div>
            <p class="text-center" style="margin-top: 0.5rem; font-size: 7pt; color: #666;">Thank you for your business!</p>
        </div>
        <!-- END: Print-Only Footer -->
      </div>
      <footer class="no-print p-4 text-center text-xs text-slate-400 dark:text-slate-500 border-t border-slate-100 dark:border-slate-700/50">
          Invoice/Estimate template with Excel repository • Enhanced by Gemini
      </footer>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification" class="no-print fixed top-5 right-5 w-80 p-4 rounded-lg shadow-xl text-white bg-slate-800 transform translate-x-[150%] transition-transform duration-300 ease-in-out">
    <p id="notification-message"></p>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---------- Utilities ----------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const fmt = n => (isNaN(n) ? 0 : n).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const genId = (type) => `${type === 'Estimate' ? 'EST' : 'INV'}-${new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14)}`;
    const truthy = (v) => {
        if (typeof v === 'boolean') return v;
        if (typeof v === 'number') return v !== 0;
        if (typeof v === 'string') return /^(true|t|1|yes|y)$/i.test(v.trim());
        return false;
    };
    const toNum = (v) => {
        if (typeof v === 'string') v = v.replace(/[$,]/g, '');
        const n = parseFloat(v);
        return isNaN(n) ? 0 : Math.max(0, n); // Ensure non-negative
    };
    const round2 = (n) => Math.round((toNum(n)) * 100) / 100;
    const isoAddDays = (iso, d) => {
        if (!iso) return '';
        const dt = new Date(iso);
        dt.setUTCDate(dt.getUTCDate() + toNum(d));
        return dt.toISOString().slice(0, 10);
    };
    // HTML escape to prevent XSS
    const escapeHtml = (str) => {
        const div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
    };

    // ---------- Google Authentication & Drive ----------
    const GOOGLE_CONFIG = {
        // IMPORTANT: Replace with your actual Google OAuth Client ID
        // Get one at: https://console.cloud.google.com/apis/credentials
        CLIENT_ID: '102862528480-0f2q6s4ojar6dp44omcp39par8sutb5g.apps.googleusercontent.com',
        API_KEY: 'AIzaSyA-CB_dfOxsp_JTkMgBVyS8jn5HSBFLLas',
        DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        SCOPES: 'https://www.googleapis.com/auth/drive.file',
        FOLDER_NAME: 'OAK_Invoicing_Data'
    };

    let googleAuth = {
        isSignedIn: false,
        accessToken: null,
        userInfo: null,
        folderId: null
    };

    function initGoogleAuth() {
        // Initialize Google Identity Services
        if (typeof google === 'undefined' || !google.accounts) {
            console.error('Google Identity Services not loaded');
            return;
        }

        // Use OAuth2 token client directly - single auth flow for both identity and Drive access
        window.googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CONFIG.CLIENT_ID,
            scope: GOOGLE_CONFIG.SCOPES + ' openid profile email',
            callback: handleTokenResponse
        });

        // Set up the sign-in button to trigger OAuth2 flow directly
        const signInBtn = document.getElementById('google-signin-button');
        if (signInBtn) {
            signInBtn.innerHTML = `
                <button onclick="window.googleTokenClient.requestAccessToken()"
                    class="flex items-center gap-3 px-6 py-3 bg-white border border-gray-300 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="text-gray-700 font-medium">Sign in with Google</span>
                </button>
            `;
        }

        // Check if user was previously signed in
        const savedToken = sessionStorage.getItem('google_access_token');
        const savedUserInfo = sessionStorage.getItem('google_user_info');
        if (savedToken && savedUserInfo) {
            googleAuth.accessToken = savedToken;
            googleAuth.userInfo = JSON.parse(savedUserInfo);
            googleAuth.isSignedIn = true;
            initGapi().then(() => {
                // Verify that folder ID was successfully retrieved
                if (!googleAuth.folderId) {
                    console.warn('Failed to retrieve folder ID, session may be expired');
                    signOut();
                    showNotification('Session expired. Please sign in again.', 'warn');
                    return;
                }
                showAuthenticatedUI();
            }).catch((error) => {
                console.error('Error restoring session:', error);
                signOut();
                showNotification('Session expired. Please sign in again.', 'warn');
            });
        }
    }

    function handleTokenResponse(tokenResponse) {
        if (tokenResponse.error) {
            console.error('Token error:', tokenResponse.error);
            showNotification('Sign in failed. Please try again.', 'error');
            return;
        }

        googleAuth.accessToken = tokenResponse.access_token;
        googleAuth.isSignedIn = true;

        // Get user info from the token
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
        })
        .then(res => res.json())
        .then(userInfo => {
            googleAuth.userInfo = {
                name: userInfo.name,
                email: userInfo.email,
                picture: userInfo.picture
            };

            // Save to session storage
            sessionStorage.setItem('google_access_token', googleAuth.accessToken);
            sessionStorage.setItem('google_user_info', JSON.stringify(googleAuth.userInfo));

            initGapi().then(() => {
                showAuthenticatedUI();
                showNotification('Signed in successfully!', 'success');
            }).catch((error) => {
                console.error('Error initializing GAPI:', error);
                signOut();
                showNotification('Error signing in. Please try again.', 'error');
            });
        })
        .catch(error => {
            console.error('Error getting user info:', error);
            // Continue anyway with minimal user info
            googleAuth.userInfo = { name: 'User', email: '' };
            sessionStorage.setItem('google_access_token', googleAuth.accessToken);
            sessionStorage.setItem('google_user_info', JSON.stringify(googleAuth.userInfo));

            initGapi().then(() => {
                showAuthenticatedUI();
                showNotification('Signed in successfully!', 'success');
            });
        });
    }

    function initGapi() {
        return new Promise((resolve, reject) => {
            if (typeof gapi === 'undefined') {
                reject('Google API not loaded');
                return;
            }

            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_CONFIG.API_KEY,
                        discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS
                    });

                    gapi.client.setToken({ access_token: googleAuth.accessToken });

                    // Find or create the invoicing folder
                    await ensureInvoicingFolder();
                    resolve();
                } catch (error) {
                    console.error('Error initializing GAPI:', error);
                    reject(error);
                }
            });
        });
    }

    async function ensureInvoicingFolder() {
        try {
            const response = await gapi.client.drive.files.list({
                q: `name='${GOOGLE_CONFIG.FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                spaces: 'drive',
                fields: 'files(id, name)'
            });

            if (response.result.files && response.result.files.length > 0) {
                googleAuth.folderId = response.result.files[0].id;
            } else {
                // Create the folder
                const folderMetadata = {
                    name: GOOGLE_CONFIG.FOLDER_NAME,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                googleAuth.folderId = folder.result.id;
            }
        } catch (error) {
            console.error('Error ensuring folder exists:', error);
            showNotification('Error accessing Google Drive', 'error');
        }
    }

    function showAuthenticatedUI() {
        $('#auth-section').classList.add('hidden');
        $('#user-profile').classList.remove('hidden');
        $('#app-header').classList.remove('hidden');
        $('#main-content').classList.remove('hidden');

        $('#user-name').textContent = googleAuth.userInfo.name;
        $('#user-email').textContent = googleAuth.userInfo.email;
        $('#user-avatar').src = googleAuth.userInfo.picture;

        // Auto-load latest invoice from Drive
        autoLoadFromDrive();
    }

    function signOut() {
        googleAuth.isSignedIn = false;
        googleAuth.accessToken = null;
        googleAuth.userInfo = null;
        googleAuth.folderId = null;

        sessionStorage.removeItem('google_access_token');
        sessionStorage.removeItem('google_user_info');

        if (typeof google !== 'undefined' && google.accounts) {
            google.accounts.id.disableAutoSelect();
        }

        $('#auth-section').classList.remove('hidden');
        $('#user-profile').classList.add('hidden');
        $('#app-header').classList.add('hidden');
        $('#main-content').classList.add('hidden');

        showNotification('Signed out successfully', 'info');
    }

    async function saveToDrive() {
        console.log('=== SAVE TO DRIVE START ===');
        console.log('Auth status:', { isSignedIn: googleAuth.isSignedIn, hasFolderId: !!googleAuth.folderId, hasToken: !!googleAuth.accessToken });

        if (!googleAuth.isSignedIn) {
            console.error('Not signed in');
            showNotification('Please sign in to save to Google Drive', 'warn');
            return;
        }

        if (!googleAuth.folderId) {
            console.error('No folder ID');
            showNotification('Drive folder not initialized. Please sign in again.', 'error');
            signOut();
            return;
        }

        try {
            updateSyncStatus('syncing', 'Saving...');
            console.log('Generating workbook...');

            // Clear lastWorkbook to avoid issues with old format data
            lastWorkbook = null;

            const wb = generateWorkbook();

            let wbout;
            try {
                wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            } catch (xlsxError) {
                console.error('XLSX write error:', xlsxError);
                // If still failing, try without attachments
                if (xlsxError.message && xlsxError.message.includes('32767')) {
                    showNotification('Attachment too large. Saving without attachments...', 'warn');
                    // Remove attachments and try again
                    const ws = wb.Sheets['Attachments'];
                    if (ws) {
                        wb.Sheets['Attachments'] = XLSX.utils.json_to_sheet([]);
                    }
                    wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                } else {
                    throw xlsxError;
                }
            }

            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            console.log('Workbook generated, size:', blob.size, 'bytes');

            // Use timestamp to create unique filename to avoid permission issues
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const fileName = `invoice_${state.number || 'draft'}_${timestamp}.xlsx`;
            console.log('Filename:', fileName);

            const metadata = {
                name: fileName,
                mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                parents: [googleAuth.folderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            // Always create new file to avoid 403 permission errors
            const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            console.log('Uploading to:', url);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAuth.accessToken}`
                },
                body: form
            });

            console.log('Response status:', response.status, response.statusText);

            if (response.ok) {
                const result = await response.json();
                updateSyncStatus('synced', 'Synced');
                showNotification(`✓ Saved as: ${fileName}`, 'success');
                console.log('✓ Saved to Drive successfully:', result);
            } else {
                const errorText = await response.text();
                console.error('✗ Drive API error:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
            }
        } catch (error) {
            console.error('✗ Error saving to Drive:', error);
            updateSyncStatus('error', 'Sync failed');
            showNotification(`✗ Error: ${error.message}`, 'error');
        }
    }

    async function loadFromDrive() {
        console.log('=== LOAD FROM DRIVE START ===');
        console.log('Auth status:', { isSignedIn: googleAuth.isSignedIn, hasFolderId: !!googleAuth.folderId });

        if (!googleAuth.isSignedIn) {
            console.error('Not signed in');
            showNotification('Please sign in to load from Google Drive', 'warn');
            return;
        }

        if (!googleAuth.folderId) {
            console.error('No folder ID');
            showNotification('Drive folder not initialized. Please sign in again.', 'error');
            signOut();
            return;
        }

        try {
            updateSyncStatus('syncing', 'Loading...');
            console.log('Fetching files from folder:', googleAuth.folderId);

            const response = await gapi.client.drive.files.list({
                q: `'${googleAuth.folderId}' in parents and trashed=false and mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'`,
                spaces: 'drive',
                fields: 'files(id, name, modifiedTime)',
                orderBy: 'modifiedTime desc',
                pageSize: 10
            });

            console.log('Files found:', response.result.files?.length || 0);

            if (!response.result.files || response.result.files.length === 0) {
                showNotification('No invoices found in Google Drive', 'warn');
                updateSyncStatus('synced', 'Synced');
                return;
            }

            const files = response.result.files;
            let fileId;

            if (files.length === 1) {
                fileId = files[0].id;
            } else {
                const fileList = files.map((f, i) => `${i + 1}. ${f.name} (${new Date(f.modifiedTime).toLocaleDateString()})`).join('\n');
                const choice = prompt(`Multiple files found. Choose one:\n${fileList}\n\nEnter number (1-${files.length}):`, '1');
                const idx = parseInt(choice) - 1;
                if (idx >= 0 && idx < files.length) {
                    fileId = files[idx].id;
                } else {
                    updateSyncStatus('synced', 'Synced');
                    return;
                }
            }

            const file = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });

            const arrayBuffer = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: {
                    'Authorization': `Bearer ${googleAuth.accessToken}`
                }
            }).then(r => r.arrayBuffer());

            const wb = XLSX.read(arrayBuffer, { type: 'array' });
            lastWorkbook = wb;

            const recs = sheetToJSON(wb, 'Records');
            if (!recs.length) {
                showNotification('No records found in file', 'warn');
                updateSyncStatus('synced', 'Synced');
                return;
            }

            let id = recs[0].id;
            if (recs.length > 1) {
                const msg = 'Multiple records found. Enter an ID to load:\n' + recs.map(r => `${r.id} — ${r.type} #${r.number}`).join('\n');
                const typed = prompt(msg, recs[0].id);
                if (typed) id = typed; else {
                    updateSyncStatus('synced', 'Synced');
                    return;
                }
            }

            loadRecordFromWorkbook(wb, id);
            updateSyncStatus('synced', 'Synced');
            showNotification('Loaded from Google Drive successfully!', 'success');
        } catch (error) {
            console.error('Error loading from Drive:', error);
            updateSyncStatus('error', 'Sync failed');
            showNotification('Error loading from Google Drive', 'error');
        }
    }

    async function autoLoadFromDrive() {
        if (!googleAuth.isSignedIn || !googleAuth.folderId) return;

        try {
            const response = await gapi.client.drive.files.list({
                q: `'${googleAuth.folderId}' in parents and trashed=false and mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'`,
                spaces: 'drive',
                fields: 'files(id, name, modifiedTime)',
                orderBy: 'modifiedTime desc',
                pageSize: 1
            });

            if (response.result.files && response.result.files.length > 0) {
                const fileId = response.result.files[0].id;

                const arrayBuffer = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': `Bearer ${googleAuth.accessToken}`
                    }
                }).then(r => r.arrayBuffer());

                const wb = XLSX.read(arrayBuffer, { type: 'array' });
                lastWorkbook = wb;

                const recs = sheetToJSON(wb, 'Records');
                if (recs.length > 0) {
                    loadRecordFromWorkbook(wb, recs[0].id);
                }
            }
        } catch (error) {
            console.error('Error auto-loading from Drive:', error);
        }
    }

    function updateSyncStatus(status, text) {
        const syncStatus = $('#sync-status');
        const syncText = $('#sync-text');

        syncStatus.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'bg-yellow-100', 'dark:bg-yellow-900/30', 'bg-red-100', 'dark:bg-red-900/30');

        if (status === 'synced') {
            syncStatus.classList.add('bg-green-100', 'dark:bg-green-900/30');
        } else if (status === 'syncing') {
            syncStatus.classList.add('bg-yellow-100', 'dark:bg-yellow-900/30');
        } else if (status === 'error') {
            syncStatus.classList.add('bg-red-100', 'dark:bg-red-900/30');
        }

        syncText.textContent = text;
    }

    // ---------- Company Settings ----------
    let companySettings = {
        name: 'OAK Builders LLC',
        address: '123 Construction Way',
        city: 'Fairfax, VA 22030, USA',
        email: 'info@oakllc.co',
        phone: '(202) 888-9895',
        website: 'www.oakllc.co',
        paymentMethods: {
            zelle: 'payments@oakllc.co',
            venmo: '@oak-builders'
        },
        paymentTerms: 'Payment is due upon receipt. Late payments are subject to a service charge of 1.5% per month on all outstanding balances.',
        defaultNotes: 'Thanks for your business.'
    };

    // Load company settings from localStorage
    function loadCompanySettings() {
        const saved = localStorage.getItem('companySettings');
        if (saved) {
            try {
                companySettings = { ...companySettings, ...JSON.parse(saved) };
            } catch (e) {
                console.error('Error loading company settings:', e);
            }
        }
    }

    // Save company settings to localStorage
    function saveCompanySettings() {
        try {
            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            showNotification('Company settings saved!', 'success');
        } catch (e) {
            console.error('Error saving company settings:', e);
            showNotification('Error saving settings', 'error');
        }
    }

    // ---------- Invoice Templates ----------
    const invoiceTemplates = {
        standard: {
            name: 'Standard Invoice',
            notes: 'Thanks for your business.',
            adjustments: { bond: false, oh: false, profit: false },
            taxPct: 0,
            dueInDays: 15
        },
        construction: {
            name: 'Construction Project',
            notes: 'Thank you for choosing us for your construction project. Payment terms are outlined below.',
            adjustments: { bond: true, oh: true, profit: true },
            taxPct: 6,
            dueInDays: 30
        },
        quickEstimate: {
            name: 'Quick Estimate',
            notes: 'This estimate is valid for 30 days. Final pricing may vary based on project scope.',
            adjustments: { bond: false, oh: true, profit: true },
            taxPct: 0,
            dueInDays: 7
        },
        maintenance: {
            name: 'Maintenance Service',
            notes: 'Regular maintenance completed. Thank you for your continued business.',
            adjustments: { bond: false, oh: false, profit: false },
            taxPct: 6,
            dueInDays: 15
        }
    };

    // ---------- State Management ----------
    let state = getInitialState();
    let lastWorkbook = null;

    function getInitialState() {
        return {
            type: 'Invoice',
            id: '',
            number: '',
            status: 'Draft',
            date: todayISO(),
            dueInDays: 15,
            payments: [], // { date, amount, method }
            showPaymentTracker: false,
            billTo: '',
            notes: companySettings.defaultNotes,
            items: [{ desc: '', qty: 1, rate: 0, usesSub: false, subs: [] }],
            adjustments: [
                { id: 'bond', label: 'Bond', enabled: false, pct: 10 },
                { id: 'oh', label: 'Overhead', enabled: false, pct: 15 },
                { id: 'profit', label: 'Profit', enabled: false, pct: 10 },
            ],
            taxPct: 0,
            attachments: [], // {filename, mime, base64, size}
            logoDataUrl: null,
            stampType: 'None',
            templateKey: '' // Track selected template
        };
    }

    function applyTemplate(templateKey) {
        const template = invoiceTemplates[templateKey];
        if (!template) {
            console.error('Template not found:', templateKey);
            return;
        }

        console.log('Applying template:', template.name);
        state.templateKey = templateKey; // Store selected template
        state.notes = template.notes;
        state.dueInDays = template.dueInDays;
        state.taxPct = template.taxPct;

        // Apply adjustment settings
        const bondAdj = state.adjustments.find(a => a.id === 'bond');
        const ohAdj = state.adjustments.find(a => a.id === 'oh');
        const profitAdj = state.adjustments.find(a => a.id === 'profit');

        if (bondAdj) bondAdj.enabled = template.adjustments.bond;
        if (ohAdj) ohAdj.enabled = template.adjustments.oh;
        if (profitAdj) profitAdj.enabled = template.adjustments.profit;

        console.log('Template applied. Rendering...');
        render();
        showNotification(`Applied template: ${template.name}`, 'success');
    }
    
    // Completely replaces the state and triggers a full re-render.
    function setStateAndRender(newState) {
        state = newState;
        render();
    }

    function normalizeItem(it) {
        if (!it || typeof it !== 'object') return { desc: '', qty: 1, rate: 0, usesSub: false, subs: [] };
        return {
            desc: String(it.desc ?? '').substring(0, 500), // Limit description length
            qty: Math.max(0, toNum(it.qty) || 1), // Ensure positive, default to 1
            rate: Math.max(0, toNum(it.rate)), // Ensure non-negative
            usesSub: truthy(it.usesSub),
            subs: Array.isArray(it.subs) ? it.subs.map(s => ({
                desc: String(s?.desc ?? '').substring(0, 200),
                qty: Math.max(0, toNum(s?.qty) || 1),
                rate: Math.max(0, toNum(s?.rate))
            })) : []
        };
    }

    function normalizeState() {
        if (!Array.isArray(state.items) || state.items.length === 0) {
            state.items = [{ desc: '', qty: 1, rate: 0, usesSub: false, subs: [] }];
        }
        state.items = state.items.map(it => normalizeItem(it));
        if (!Array.isArray(state.payments)) {
            state.payments = [];
        }
    }


    // ---------- Rendering Engine ----------
    function render() {
        normalizeState();
        // Full UI redraws - necessary when structure changes (e.g., adding/deleting items)
        renderHeader();
        renderItems();
        renderPayments();
        renderAdjustments();
        renderAttachments();
        // Calculation and painting of values - can be called separately for performance
        calculateAndPaintTotals();
        renderPrintViews(); 
    }
    
    function renderHeader() {
        $('#docType').value = state.type;
        $('#docTitle').textContent = state.type;
        $('#recId').value = state.id;
        $('#invNo').value = state.number;
        $('#status').value = state.status;
        $('#invDate').value = state.date;
        $('#dueIn').value = String(state.dueInDays);
        $('#billTo').value = state.billTo;
        $('#notes').value = state.notes;
        $('#taxRate').value = state.taxPct;
        $('#stampType').value = state.stampType;
        $('#templateSelect').value = state.templateKey || ''; // Show selected template

        const isInv = state.type === 'Invoice';
        $('#dueWrap').classList.toggle('hidden', !isInv);
        $('#paidWrap').classList.toggle('hidden', !isInv);
        $('#balanceRow').classList.toggle('hidden', !isInv);

        $('#ui-logo').src = state.logoDataUrl || 'https://placehold.co/80x80/b8860b/FFFFFF?text=OAK';
        $('#print-logo').src = state.logoDataUrl || 'https://placehold.co/128x128/b8860b/FFFFFF?text=OAK';

        // Update print header with company settings
        updatePrintHeader();
    }

    function updatePrintHeader() {
        $('#print-company-name').textContent = companySettings.name;
        $('#print-company-address').textContent = companySettings.address;
        $('#print-company-city').textContent = companySettings.city;
        $('#print-company-email').textContent = companySettings.email;
        $('#print-company-phone').textContent = companySettings.phone;
        $('#print-company-website').textContent = companySettings.website;
        $('#paymentTerms').textContent = companySettings.paymentTerms;
        $('#print-payment-zelle').textContent = `Zelle: ${companySettings.paymentMethods.zelle}`;
        $('#print-payment-venmo').textContent = `Venmo: ${companySettings.paymentMethods.venmo}`;
    }
    
    function lineAmount(it) {
        if (!it) return 0;
        if (it.usesSub && Array.isArray(it.subs) && it.subs.length > 0) {
            return it.subs.reduce((s, si) => s + (toNum(si.qty) * toNum(si.rate)), 0);
        }
        return toNum(it.qty) * toNum(it.rate);
    }

    function renderItems() {
        const tbody = $('#items tbody');
        tbody.innerHTML = state.items.map((it, idx) => `
            <tr class="border-b border-slate-200 dark:border-slate-700 last:border-b-0 print:border-gray-300">
                <td class="px-3 py-2 align-top print:px-2 print:py-1" data-label="Item">
                    <input class="w-full bg-transparent focus:outline-none text-sm print:text-xs" placeholder="Item description" value="${escapeHtml(it.desc)}" data-idx="${idx}" data-field="desc">
                    ${it.usesSub ? renderSubItems(it, idx) : ''}
                    <div class="no-print mt-2">
                        <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
                            <input type="checkbox" ${it.usesSub ? 'checked' : ''} class="rounded text-accent focus:ring-accent/50" data-idx="${idx}" data-action="toggleSub">
                            Use sub-items
                        </label>
                    </div>
                </td>
                <td class="px-3 py-2 align-top print:px-2 print:py-1" data-label="Qty">
                    <input type="number" min="0" value="${escapeHtml(it.qty)}" ${it.usesSub ? 'disabled' : ''} class="w-20 bg-transparent focus:outline-none disabled:text-slate-400 dark:disabled:text-slate-500 text-right text-sm print:text-xs print:w-auto" data-idx="${idx}" data-field="qty">
                </td>
                <td class="px-3 py-2 align-top print:px-2 print:py-1" data-label="Rate">
                    <input type="number" min="0" step="0.01" value="${escapeHtml(it.rate)}" ${it.usesSub ? 'disabled' : ''} class="w-28 bg-transparent focus:outline-none disabled:text-slate-400 dark:disabled:text-slate-500 text-right text-sm print:text-xs print:w-auto" data-idx="${idx}" data-field="rate">
                </td>
                <td class="px-3 py-2 align-top text-right font-medium text-slate-600 dark:text-slate-300 print:text-gray-800 text-sm print:text-xs print:px-2 print:py-1" data-role="line-amount" data-label="Amount">
                    ${fmt(lineAmount(it))}
                </td>
                <td class="px-3 py-2 align-top text-center no-print">
                    <button class="text-slate-400 hover:text-red-500 text-sm" data-action="delItem" data-idx="${idx}">✕</button>
                </td>
            </tr>
        `).join('');
    }
    
    function renderSubItems(item, itemIdx) {
        const subsHTML = (item.subs || []).map((si, sidx) => `
            <div class="grid grid-cols-[1fr,auto,auto,auto,auto] gap-2 items-center text-sm">
                <input class="w-full bg-slate-100 dark:bg-slate-700/50 rounded-md p-1 focus:outline-none focus:ring-1 focus:ring-accent print-bg-transparent" placeholder="Sub-item description" value="${escapeHtml(si.desc)}" data-idx="${itemIdx}" data-sidx="${sidx}" data-sub-field="desc">
                <input type="number" min="0" value="${escapeHtml(si.qty)}" class="w-16 text-right bg-slate-100 dark:bg-slate-700/50 rounded-md p-1 focus:outline-none focus:ring-1 focus:ring-accent print-bg-transparent" data-idx="${itemIdx}" data-sidx="${sidx}" data-sub-field="qty">
                <input type="number" min="0" step="0.01" value="${escapeHtml(si.rate)}" class="w-20 text-right bg-slate-100 dark:bg-slate-700/50 rounded-md p-1 focus:outline-none focus:ring-1 focus:ring-accent print-bg-transparent" data-idx="${itemIdx}" data-sidx="${sidx}" data-sub-field="rate">
                <span class="font-medium text-slate-600 dark:text-slate-300 print:text-gray-700 text-right pr-1" data-role="sub-line-amount">${fmt(toNum(si.qty) * toNum(si.rate))}</span>
                <button class="text-slate-400 hover:text-red-500 text-xs no-print" data-action="delSubItem" data-idx="${itemIdx}" data-sidx="${sidx}">✕</button>
            </div>
        `).join('');
        return `
            <div class="mt-2 pl-4 border-l-2 border-slate-200 dark:border-slate-600 space-y-2 print:border-gray-200">
                ${subsHTML}
                 <button class="no-print text-xs text-accent dark:text-accent-light font-semibold" data-action="addSubItem" data-idx="${itemIdx}">+ Add sub-item</button>
            </div>
        `;
    }

    function renderPayments() {
        const container = $('#paymentTracker');
        container.classList.toggle('hidden', !state.showPaymentTracker);
        if (!state.showPaymentTracker) return;

        const tableContent = state.payments.length > 0 ? `
            <div class="space-y-2">
                ${state.payments.map((p, idx) => `
                    <div class="grid grid-cols-[auto,1fr,auto,auto] gap-2 items-center text-sm">
                        <input type="date" value="${p.date}" class="bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-md shadow-sm p-1 focus:ring-accent focus:border-accent" data-pay-idx="${idx}" data-pay-field="date">
                        <input type="text" value="${p.method}" placeholder="Method" class="bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-md shadow-sm p-1 focus:ring-accent focus:border-accent" data-pay-idx="${idx}" data-pay-field="method">
                        <input type="number" value="${p.amount}" class="w-24 text-right bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-md shadow-sm p-1 focus:ring-accent focus:border-accent" data-pay-idx="${idx}" data-pay-field="amount">
                        <button class="text-slate-400 hover:text-red-500 text-xs" data-action="delPayment" data-idx="${idx}">✕</button>
                    </div>
                `).join('')}
            </div>
        ` : `<p class="text-xs text-slate-500 text-center">No payments recorded.</p>`;
        
        container.innerHTML = `
            ${tableContent}
            <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                 <button data-action="addPayment" class="px-3 py-1 w-full font-semibold text-accent-dark dark:text-accent-light bg-accent/20 hover:bg-accent/30 rounded-md transition-colors">Add Payment</button>
            </div>
        `;
    }

    function renderAdjustments() {
        const container = $('#adjustments');
        container.innerHTML = state.adjustments.map((adj, idx) => `
             <div class="border-t border-slate-200 dark:border-slate-700 pt-2 print:border-gray-200">
                <div class="flex justify-between items-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${adj.enabled ? 'checked' : ''} class="rounded text-accent focus:ring-accent/50 no-print" data-adj-idx="${idx}" data-action="toggleAdj">
                        <span class="text-slate-500 dark:text-slate-400 print:text-gray-600">${adj.label}</span>
                    </label>
                    ${adj.enabled ? `
                    <div class="flex items-center gap-2">
                      <input type="number" min="0" step="0.01" value="${adj.pct}" class="w-20 text-right bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md text-sm focus:ring-accent focus:border-accent no-print" data-adj-idx="${idx}" data-field="pct">
                      <span class="text-slate-500 dark:text-slate-400 print:text-gray-600">${adj.pct}%</span>
                    </div>` : ''}
                </div>
                ${adj.enabled ? `
                <div class="flex justify-between items-center text-sm mt-1">
                    <span class="text-slate-500 dark:text-slate-400 pl-4 print:text-gray-600">${adj.label} amount</span>
                    <span id="${adj.id}Amt" class="font-medium text-slate-600 dark:text-slate-300 print:text-gray-800">$0.00</span>
                </div>` : ''}
            </div>
        `).join('');
    }
    
    function renderAttachments() {
        const list = $('#attachments');
        list.innerHTML = state.attachments.map((a, i) => `
            <div class="flex items-center justify-between gap-3 p-2 rounded-lg bg-slate-100 dark:bg-slate-700/50 text-sm print:bg-transparent print:p-0 print:gap-1">
                <div class="truncate print:flex print:items-baseline print:gap-1">
                    <strong class="font-medium text-slate-700 dark:text-slate-200 print:text-gray-900 print:text-xs">${a.filename}</strong>
                    <span class="text-slate-500 dark:text-slate-400 text-xs print:text-gray-600" style="font-size: 8pt;">(${Math.round(a.size/1024)} KB)</span>
                </div>
                <button class="no-print text-slate-400 hover:text-red-500" data-action="delAttachment" data-idx="${i}">✕</button>
            </div>
        `).join('');
    }

    function renderPrintViews() {
        $('#printInvNo').textContent = state.number;
        $('#printInvDate').textContent = state.date;
        const dueDate = isoAddDays(state.date, state.dueInDays);
        $('#printDueDate').textContent = dueDate;
        $('#printTaxRate').textContent = `${state.taxPct}%`;
        $('#printDueWrap').classList.toggle('hidden', state.type !== 'Invoice');

        // Update compact header
        $('#print-doc-title').textContent = state.type.toUpperCase();
        $('#print-doc-number').textContent = state.number || 'DRAFT';

        const dueDays = toNum(state.dueInDays);
        const term = dueDays > 0 ? `Payment is due within ${dueDays} days.` : 'Payment is due upon receipt.';
        $('#paymentTerms').textContent = `${term} Late payments are subject to a service charge of 1.5% per month on all outstanding balances.`;

        const stampEl = $('#print-stamp');
        if (state.stampType !== 'None') {
            stampEl.textContent = state.stampType.toUpperCase();
            stampEl.classList.remove('text-green-600', 'border-green-600', 'text-red-600', 'border-red-600', 'text-gray-600', 'border-gray-600');
            switch (state.stampType) {
                case 'Paid': stampEl.classList.add('text-green-600', 'border-green-600'); break;
                case 'Overdue': stampEl.classList.add('text-red-600', 'border-red-600'); break;
                default: stampEl.classList.add('text-gray-600', 'border-gray-600'); break;
            }
        }
        stampEl.style.display = state.stampType === 'None' ? 'none' : 'block';
    }

    function calculateAndPaintTotals() {
        const totalPaid = state.payments.reduce((sum, p) => sum + toNum(p.amount), 0);
        $('#paid').value = fmt(totalPaid);
        $('#paidTotal').textContent = fmt(totalPaid);

        let subtotal = state.items.reduce((s, it) => s + lineAmount(it), 0);
        let currentBase = subtotal;
        
        state.adjustments.forEach(adj => {
            const adjAmt = adj.enabled ? currentBase * (toNum(adj.pct) / 100) : 0;
            const el = $(`#${adj.id}Amt`);
            if (el) el.textContent = fmt(adjAmt);
            currentBase += adjAmt;
        });
        
        const taxBase = currentBase;
        const taxAmt = taxBase * (toNum(state.taxPct) / 100);
        const total = taxBase + taxAmt;
        const due = Math.max(total - (state.type === 'Invoice' ? totalPaid : 0), 0);
        
        $('#subtotal').textContent = fmt(subtotal);
        $('#tax').textContent = fmt(taxAmt);
        $('#total').textContent = fmt(total);
        $('#due').textContent = fmt(due);

        // Update individual line item and sub-item amounts in the DOM
        $$('#items tbody tr').forEach((row, i) => {
            const item = state.items[i];
            if (!item) return;
            const amountEl = row.querySelector('[data-role="line-amount"]');
            if (amountEl) amountEl.textContent = fmt(lineAmount(item));
            if (item.usesSub && item.subs) {
                $$('[data-role="sub-line-amount"]', row).forEach((subEl, j) => {
                    const subItem = item.subs[j];
                    if (subItem) subEl.textContent = fmt(toNum(subItem.qty) * toNum(subItem.rate));
                });
            }
        });
    }
    
    // ---------- Settings Modal ----------
    function openSettingsModal() {
        $('#settings-name').value = companySettings.name;
        $('#settings-address').value = companySettings.address;
        $('#settings-city').value = companySettings.city;
        $('#settings-email').value = companySettings.email;
        $('#settings-phone').value = companySettings.phone;
        $('#settings-website').value = companySettings.website;
        $('#settings-zelle').value = companySettings.paymentMethods.zelle;
        $('#settings-venmo').value = companySettings.paymentMethods.venmo;
        $('#settings-terms').value = companySettings.paymentTerms;
        $('#settings-notes').value = companySettings.defaultNotes;

        $('#settings-modal').classList.remove('hidden');
    }

    function closeSettingsModal() {
        $('#settings-modal').classList.add('hidden');
    }

    function saveSettingsFromModal() {
        companySettings.name = $('#settings-name').value;
        companySettings.address = $('#settings-address').value;
        companySettings.city = $('#settings-city').value;
        companySettings.email = $('#settings-email').value;
        companySettings.phone = $('#settings-phone').value;
        companySettings.website = $('#settings-website').value;
        companySettings.paymentMethods.zelle = $('#settings-zelle').value;
        companySettings.paymentMethods.venmo = $('#settings-venmo').value;
        companySettings.paymentTerms = $('#settings-terms').value;
        companySettings.defaultNotes = $('#settings-notes').value;

        saveCompanySettings();
        updatePrintHeader();
        closeSettingsModal();
    }

    // ---------- Repository ----------
    let repositoryData = [];
    let repositoryWorkbooks = {};

    function openRepositoryModal() {
        if (!googleAuth.isSignedIn) {
            showNotification('Please sign in to access the repository', 'warn');
            return;
        }
        $('#repository-modal').classList.remove('hidden');
        loadRepository();
    }

    function closeRepositoryModal() {
        $('#repository-modal').classList.add('hidden');
    }

    async function loadRepository() {
        if (!googleAuth.isSignedIn || !googleAuth.folderId) {
            showNotification('Please sign in first', 'warn');
            return;
        }

        // Show loading state
        $('#repository-loading').classList.remove('hidden');
        $('#repository-empty').classList.add('hidden');
        $('#repository-table').classList.add('hidden');

        try {
            const response = await gapi.client.drive.files.list({
                q: `'${googleAuth.folderId}' in parents and trashed=false and mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'`,
                spaces: 'drive',
                fields: 'files(id, name, modifiedTime)',
                orderBy: 'modifiedTime desc',
                pageSize: 100
            });

            const files = response.result.files || [];
            repositoryData = [];
            repositoryWorkbooks = {};

            // Load each file and extract records
            for (const file of files) {
                try {
                    const arrayBuffer = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${googleAuth.accessToken}` }
                    }).then(r => r.arrayBuffer());

                    const wb = XLSX.read(arrayBuffer, { type: 'array' });
                    const records = sheetToJSON(wb, 'Records');

                    records.forEach(rec => {
                        repositoryData.push({
                            ...rec,
                            _fileId: file.id,
                            _fileName: file.name,
                            _modifiedTime: file.modifiedTime
                        });
                        repositoryWorkbooks[rec.id] = { wb, fileId: file.id };
                    });
                } catch (e) {
                    console.warn('Error reading file:', file.name, e);
                }
            }

            renderRepository();
        } catch (error) {
            console.error('Error loading repository:', error);
            showNotification('Error loading repository', 'error');
        } finally {
            $('#repository-loading').classList.add('hidden');
        }
    }

    function renderRepository() {
        const filterType = $('#repo-filter-type').value;
        const filterStatus = $('#repo-filter-status').value;
        const searchTerm = $('#repo-search').value.toLowerCase();

        // Filter data
        let filtered = repositoryData.filter(rec => {
            if (filterType && rec.type !== filterType) return false;
            if (filterStatus && rec.status !== filterStatus) return false;
            if (searchTerm) {
                const searchFields = `${rec.number} ${rec.client_name} ${rec.client_company}`.toLowerCase();
                if (!searchFields.includes(searchTerm)) return false;
            }
            return true;
        });

        // Sort by date descending
        filtered.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

        const tbody = $('#repository-body');

        if (filtered.length === 0) {
            $('#repository-empty').classList.remove('hidden');
            $('#repository-table').classList.add('hidden');
            $('#repo-stats').textContent = '';
            return;
        }

        $('#repository-empty').classList.add('hidden');
        $('#repository-table').classList.remove('hidden');

        // Calculate totals
        let totalInvoiced = 0;
        let totalPaid = 0;
        filtered.forEach(rec => {
            if (rec.type === 'Invoice') {
                totalInvoiced += toNum(rec.total);
                totalPaid += toNum(rec.paid);
            }
        });

        $('#repo-total-invoiced').textContent = fmt(totalInvoiced);
        $('#repo-total-paid').textContent = fmt(totalPaid);
        $('#repo-total-outstanding').textContent = fmt(totalInvoiced - totalPaid);
        $('#repo-stats').textContent = `${filtered.length} document${filtered.length !== 1 ? 's' : ''}`;

        // Status badge colors
        const statusColors = {
            'Draft': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
            'Sent': 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300',
            'Approved': 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300',
            'Paid': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300',
            'Rejected': 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300'
        };

        tbody.innerHTML = filtered.map(rec => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                <td class="px-3 py-2">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${rec.type === 'Invoice' ? 'bg-accent/10 text-accent-dark' : 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300'}">
                        ${escapeHtml(rec.type)}
                    </span>
                </td>
                <td class="px-3 py-2 font-medium text-slate-700 dark:text-slate-200">#${escapeHtml(rec.number || 'N/A')}</td>
                <td class="px-3 py-2">
                    <div class="text-sm text-slate-700 dark:text-slate-200">${escapeHtml(rec.client_name || 'Unknown')}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">${escapeHtml(rec.client_company || '')}</div>
                </td>
                <td class="px-3 py-2 text-sm text-slate-600 dark:text-slate-300">${rec.date || 'N/A'}</td>
                <td class="px-3 py-2 text-right font-medium text-slate-700 dark:text-slate-200">${fmt(rec.total)}</td>
                <td class="px-3 py-2 text-center">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColors[rec.status] || statusColors['Draft']}">
                        ${escapeHtml(rec.status || 'Draft')}
                    </span>
                </td>
                <td class="px-3 py-2 text-center">
                    <button class="text-accent hover:text-accent-dark dark:hover:text-accent-light text-sm font-medium" data-action="loadFromRepo" data-rec-id="${escapeHtml(rec.id)}">
                        Open
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function loadFromRepository(recId) {
        const entry = repositoryWorkbooks[recId];
        if (!entry) {
            showNotification('Record not found in repository', 'error');
            return;
        }
        loadRecordFromWorkbook(entry.wb, recId);
        closeRepositoryModal();
        showNotification(`Loaded: ${recId}`, 'success');
    }

    function createNewDocument() {
        if (state.id && !confirm('Create a new document? Unsaved changes will be lost.')) {
            return;
        }
        setStateAndRender(getInitialState());
        closeRepositoryModal();
        showNotification('New document created', 'success');
    }

    // ---------- Email Invoice ----------
    function emailInvoice() {
        // Validate that we have essential info
        if (!state.number) {
            showNotification('Please add an invoice number first', 'warn');
            return;
        }

        // Extract client email from billTo field
        const billToLines = (state.billTo || '').split('\n');
        const emailLine = billToLines.find(line => line.includes('@'));
        const emailMatch = emailLine ? emailLine.match(/[\w.-]+@[\w.-]+\.\w+/) : null;
        const clientEmail = emailMatch ? emailMatch[0] : '';

        if (!clientEmail) {
            const userEmail = prompt('Enter client email address:', '');
            if (!userEmail) return;
            createEmailDraft(userEmail);
        } else {
            createEmailDraft(clientEmail);
        }
    }

    function createEmailDraft(toEmail) {
        const docType = state.type;
        const docNumber = state.number;
        const total = calculateTotal();
        const attachmentCount = state.attachments.length;

        console.log('📧 Creating email draft');
        console.log('Attachments in state:', state.attachments.length);
        console.log('Attachment details:', state.attachments.map(a => ({ name: a.filename, size: a.size })));

        // Build attachment list for email body
        let attachmentSection = '';
        if (attachmentCount > 0) {
            attachmentSection = `

ATTACHMENTS INCLUDED (${attachmentCount} file${attachmentCount > 1 ? 's' : ''}):
${state.attachments.map((a, i) => `  ${i+1}. ${a.filename} (${Math.round(a.size/1024)} KB)`).join('\n')}

*** IMPORTANT: Please download and attach the above files from the invoice app ***`;
        }

        const subject = encodeURIComponent(`${docType} #${docNumber} from ${companySettings.name}`);
        const body = encodeURIComponent(`Dear Client,

Please find attached ${docType} #${docNumber}.

${docType} Details:
- ${docType} Number: ${docNumber}
- Date: ${state.date}
${state.type === 'Invoice' ? `- Due Date: ${isoAddDays(state.date, state.dueInDays)}\n` : ''}- Total Amount: ${fmt(total)}
${attachmentSection}

${state.notes}

Payment Methods:
- Zelle: ${companySettings.paymentMethods.zelle}
- Venmo: ${companySettings.paymentMethods.venmo}

${companySettings.paymentTerms}

Thank you for your business!

Best regards,
${companySettings.name}
${companySettings.email}
${companySettings.phone}
`);

        const mailtoLink = `mailto:${toEmail}?subject=${subject}&body=${body}`;
        window.location.href = mailtoLink;

        // If there are attachments, trigger downloads
        if (attachmentCount > 0) {
            showNotification(`📧 Email opened! Downloading ${attachmentCount} attachment${attachmentCount > 1 ? 's' : ''}...`, 'success');
            // Download each attachment with a small delay
            state.attachments.forEach((att, idx) => {
                setTimeout(() => downloadAttachment(att), idx * 500);
            });
        } else {
            showNotification(`📧 Email opened! Print to PDF and attach to email.`, 'success');
        }

        // Log detailed instructions to console
        console.log(`
📧 EMAIL INSTRUCTIONS:
══════════════════════════════════════
1. Print this page to PDF (Ctrl+P or Cmd+P)
2. Attach the PDF to the email that just opened
${attachmentCount > 0 ? `3. ATTACH THESE ${attachmentCount} FILE(S) (auto-downloaded):\n${state.attachments.map(a => `   ✓ ${a.filename} (${Math.round(a.size/1024)} KB)`).join('\n')}` : ''}
══════════════════════════════════════
        `);
    }

    function downloadAttachment(attachment) {
        try {
            const byteCharacters = atob(attachment.base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: attachment.mime });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = attachment.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Error downloading attachment:', attachment.filename, error);
        }
    }

    function calculateTotal() {
        const totalPaid = state.payments.reduce((sum, p) => sum + toNum(p.amount), 0);
        let subtotal = state.items.reduce((s, it) => s + lineAmount(it), 0);
        let currentBase = subtotal;

        state.adjustments.forEach(adj => {
            const adjAmt = adj.enabled ? currentBase * (toNum(adj.pct) / 100) : 0;
            currentBase += adjAmt;
        });

        const taxBase = currentBase;
        const taxAmt = taxBase * (toNum(state.taxPct) / 100);
        return taxBase + taxAmt;
    }

    // ---------- Event Handling ----------
    function setupEventListeners() {
        const app = $('#app-card');
        app.addEventListener('input', handleLiveUpdate);
        app.addEventListener('click', handleClick);
        app.addEventListener('change', handleStructuralChange);

        // These are outside the main app card, so they get separate listeners.
        $('#filePicker').addEventListener('change', handleFileLoad);
        $('#logoPicker').addEventListener('change', handleLogoUpload);
        $('#attachPicker').addEventListener('change', handleAttachmentChange);

        // Template selector
        $('#templateSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                applyTemplate(e.target.value);
            } else {
                state.templateKey = ''; // Clear template when "None" selected
            }
        });

        // Close modal on background click
        $('#settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') {
                closeSettingsModal();
            }
        });

        // Repository modal
        $('#repository-modal').addEventListener('click', (e) => {
            if (e.target.id === 'repository-modal') {
                closeRepositoryModal();
            }
        });

        // Repository filters
        $('#repo-filter-type').addEventListener('change', renderRepository);
        $('#repo-filter-status').addEventListener('change', renderRepository);
        $('#repo-search').addEventListener('input', renderRepository);
    }
    
    function handleLiveUpdate(e) {
        const target = e.target;
        const { idx, sidx, field, subField, adjIdx, payIdx, payField } = target.dataset;

        let requiresRecalc = false;

        if (payIdx !== undefined && payField) {
            state.payments[payIdx][payField] = target.type === 'number' ? Math.max(0, toNum(target.value)) : target.value;
            requiresRecalc = true;
        } else if (field && idx !== undefined) {
            if (target.type === 'number') {
                state.items[idx][field] = Math.max(0, toNum(target.value));
            } else {
                state.items[idx][field] = target.value.substring(0, 500); // Limit length
            }
            requiresRecalc = true;
        } else if (subField && idx !== undefined && sidx !== undefined) {
            if (target.type === 'number') {
                state.items[idx].subs[sidx][subField] = Math.max(0, toNum(target.value));
            } else {
                state.items[idx].subs[sidx][subField] = target.value.substring(0, 200);
            }
            requiresRecalc = true;
        } else if (field === 'pct' && adjIdx !== undefined) {
             state.adjustments[adjIdx].pct = Math.max(0, Math.min(100, toNum(target.value))); // 0-100%
             requiresRecalc = true;
        } else {
            const id = target.id;
            if (id === 'invNo') state.number = target.value.substring(0, 50);
            else if (id === 'billTo') state.billTo = target.value.substring(0, 500);
            else if (id === 'notes') state.notes = target.value.substring(0, 1000);
            else if (id === 'taxRate') {
                state.taxPct = Math.max(0, Math.min(100, toNum(target.value))); // 0-100%
                requiresRecalc = true;
            }
        }

        if (requiresRecalc) {
            calculateAndPaintTotals();
        }
    }
    
    function handleStructuralChange(e) {
        const target = e.target;
        const { action, idx, adjIdx } = target.dataset;
        let needsRerender = false;

        if (action === 'toggleSub') {
            state.items[idx].usesSub = target.checked;
            if (state.items[idx].usesSub && !state.items[idx].subs) state.items[idx].subs = [];
            needsRerender = true;
        } else if (action === 'toggleAdj') {
            state.adjustments[adjIdx].enabled = target.checked;
            needsRerender = true;
        } else {
            const id = target.id;
            if (['docType', 'status', 'dueIn', 'invDate', 'stampType'].includes(id)) {
                if (id === 'docType') state.type = target.value;
                if (id === 'status') state.status = target.value;
                if (id === 'dueIn') state.dueInDays = toNum(target.value);
                if (id === 'invDate') state.date = target.value;
                if (id === 'stampType') state.stampType = target.value;
                needsRerender = true;
            }
        }
        
        if(needsRerender) render();
    }

    function handleClick(e) {
        const target = e.target.closest('button');
        if (!target) return;
        const { action, idx, sidx } = target.dataset;

        let needsRerender = false;
        switch (action) {
            case 'uploadLogo': $('#logoPicker').click(); break;
            case 'loadExcel': $('#filePicker').click(); break;
            case 'saveExcel': handleFileSave(); break;
            case 'saveToDrive': saveToDrive(); break;
            case 'loadFromDrive': loadFromDrive(); break;
            case 'signOut': signOut(); break;
            case 'openSettings': openSettingsModal(); break;
            case 'closeSettings': closeSettingsModal(); break;
            case 'saveSettings': saveSettingsFromModal(); break;
            case 'openRepository': openRepositoryModal(); break;
            case 'closeRepository': closeRepositoryModal(); break;
            case 'refreshRepository': loadRepository(); break;
            case 'newDocument': createNewDocument(); break;
            case 'loadFromRepo':
                const recId = target.dataset.recId;
                if (recId) loadFromRepository(recId);
                break;
            case 'emailInvoice': emailInvoice(); break;
            case 'toggleTheme': toggleTheme(); break;
            case 'addRow':
                state.items.push(getInitialState().items[0]);
                needsRerender = true;
                break;
            case 'clearAll':
                if (confirm('Are you sure you want to clear all items?')) {
                    state.items = getInitialState().items;
                    needsRerender = true;
                }
                break;
            case 'delItem':
                state.items.splice(idx, 1);
                if (state.items.length === 0) state.items.push(getInitialState().items[0]);
                needsRerender = true;
                break;
            case 'addSubItem':
                if (!state.items[idx].subs) state.items[idx].subs = [];
                state.items[idx].subs.push({ desc: '', qty: 1, rate: 0 });
                needsRerender = true;
                break;
            case 'delSubItem':
                state.items[idx].subs.splice(sidx, 1);
                needsRerender = true;
                break;
            case 'addPayment':
                state.payments.push({ date: todayISO(), amount: 0, method: 'New Payment' });
                needsRerender = true;
                break;
            case 'delPayment':
                state.payments.splice(idx, 1);
                needsRerender = true;
                break;
            case 'togglePayments':
                state.showPaymentTracker = !state.showPaymentTracker;
                needsRerender = true;
                break;
            case 'delAttachment':
                state.attachments.splice(idx, 1);
                needsRerender = true;
                break;
        }

        if (needsRerender) {
            render();
        }
    }
    
    async function handleLogoUpload(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
            const dataUrl = await fileToDataUrl(file);
            state.logoDataUrl = dataUrl;
            localStorage.setItem('savedLogo', dataUrl);
            renderHeader();
            showNotification('Logo updated!', 'success');
        } catch (error) {
            showNotification('Could not read logo file.', 'error');
        }
    }
    
    async function handleAttachmentChange(e) {
        for (const f of e.target.files || []) {
            try {
                const base64 = await fileToBase64(f);
                state.attachments.push({ filename: f.name, mime: f.type, base64, size: f.size });
            } catch (error) {
                showNotification(`Error reading ${f.name}.`, 'error');
            }
        }
        e.target.value = ''; // Reset picker
        renderAttachments();
    }
    
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(String(reader.result).split(',')[1] || '');
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    function fileToDataUrl(file) {
         return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }


    // ---------- Excel Import/Export (Workbook generation) ----------
    function handleFileSave() {
        if(!window.XLSX) { showNotification('Excel library not available.', 'error'); return; }
        const wb = generateWorkbook();
        const fname = `repository_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fname);
        lastWorkbook = wb;
        showNotification(`Saved to ${fname}`, 'success');
    }

    async function handleFileLoad(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        if (!window.XLSX) { showNotification('Excel library not loaded.', 'error'); return; }

        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { type: 'array' });
            lastWorkbook = wb;
            const recs = sheetToJSON(wb, 'Records');
            if (!recs.length) { showNotification('No records found in workbook.', 'warn'); return; }

            let id = recs[0].id;
            if (recs.length > 1) {
                const msg = 'Multiple records found. Enter an ID to load:\n' + recs.map(r => `${r.id} — ${r.type} #${r.number}`).join('\n');
                const typed = prompt(msg, recs[0].id);
                if (typed) id = typed; else return;
            }
            loadRecordFromWorkbook(wb, id);

        } catch (error) {
            showNotification('Failed to process Excel file.', 'error');
        } finally {
            e.target.value = ''; // Reset picker
        }
    }
    
    function generateWorkbook() {
        const wb = lastWorkbook || XLSX.utils.book_new();
        if(!state.id) state.id = genId(state.type);
        const stateId = String(state.id).trim();

        const existingRecs = sheetToJSON(wb, 'Records');
        const existingLI = sheetToJSON(wb, 'LineItems');
        const existingSI = sheetToJSON(wb, 'SubItems');
        const existingAT = sheetToJSON(wb, 'Attachments');
        const existingPayments = sheetToJSON(wb, 'Payments');

        const totalPaid = state.payments.reduce((sum, p) => sum + toNum(p.amount), 0);
        let subtotal = state.items.reduce((s, it) => s + lineAmount(it), 0);
        let currentBase = subtotal;
        let adjAmounts = {};
        state.adjustments.forEach(adj => {
            const adjAmt = adj.enabled ? currentBase * (toNum(adj.pct) / 100) : 0;
            adjAmounts[`${adj.id}_amount`] = round2(adjAmt);
            currentBase += adjAmt;
        });
        const taxAmt = round2(currentBase * (toNum(state.taxPct) / 100));
        const total = round2(currentBase + taxAmt);
        const balance = state.type === 'Invoice' ? Math.max(total - totalPaid, 0) : total;

        const bt = (state.billTo || '').split('\n');
        const client_name = bt[0] || '';
        const client_company = bt[1] || '';
        const [client_email = '', client_phone = ''] = (bt[2] || '').split('·').map(s => s.trim());
        const client_address = bt[3] || '';

        const recordRow = {
            id: state.id, type: state.type, number: state.number, date: state.date,
            due_date: state.type === 'Invoice' ? isoAddDays(state.date, state.dueInDays) : '',
            client_name, client_company, client_email, client_phone, client_address,
            notes: state.notes, status: state.status,
            subtotal: round2(subtotal),
            bond_percent: state.adjustments.find(a => a.id === 'bond').enabled ? state.adjustments.find(a => a.id === 'bond').pct : 0,
            bond_amount: adjAmounts.bond_amount,
            overhead_percent: state.adjustments.find(a => a.id === 'oh').enabled ? state.adjustments.find(a => a.id === 'oh').pct : 0,
            overhead_amount: adjAmounts.oh_amount,
            profit_percent: state.adjustments.find(a => a.id === 'profit').enabled ? state.adjustments.find(a => a.id === 'profit').pct : 0,
            profit_amount: adjAmounts.profit_amount,
            tax_percent: state.taxPct, tax_amount: taxAmt,
            total,
            paid: round2(totalPaid),
            balance: round2(balance),
            attachments_count: state.attachments.length,
            created_at: existingRecs.find(r => String(r.id).trim() === stateId)?.created_at || new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const otherRecs = existingRecs.filter(r => String(r.id).trim() !== stateId);
        const newRecs = [...otherRecs, recordRow];

        const otherLI = existingLI.filter(r => String(r.record_id).trim() !== stateId);
        const newLI = state.items.map((it, i) => ({
            record_id: state.id, line_no: i + 1, description: it.desc,
            qty: it.usesSub ? '' : round2(it.qty), rate: it.usesSub ? '' : round2(it.rate),
            amount: round2(lineAmount(it)), uses_subitems: !!it.usesSub
        }));

        const otherSI = existingSI.filter(r => String(r.record_id).trim() !== stateId);
        const newSI = state.items.flatMap((it, i) => (it.subs || []).map((s, siIdx) => ({
            record_id: state.id, line_no: i + 1, subline_no: siIdx + 1,
            description: s.desc, qty: round2(s.qty), rate: round2(s.rate),
            amount: round2(toNum(s.qty) * toNum(s.rate))
        })));
        
        const otherPayments = existingPayments.filter(p => String(p.record_id).trim() !== stateId);
        const newPayments = state.payments.map(p => ({
            record_id: state.id, date: p.date, amount: round2(p.amount), method: p.method
        }));

        // Define max cell length for Excel compatibility (32767 char limit)
        const MAX_CELL_LENGTH = 30000;

        const otherAT = existingAT.filter(r => String(r.record_id).trim() !== stateId).map(oldAtt => {
            // Re-chunk old attachments that might have the old format
            if (oldAtt.base64 && oldAtt.base64.length > MAX_CELL_LENGTH) {
                const base64 = oldAtt.base64;
                const chunks = [];
                for (let i = 0; i < base64.length; i += MAX_CELL_LENGTH) {
                    chunks.push(base64.substring(i, i + MAX_CELL_LENGTH));
                }
                const row = {
                    record_id: oldAtt.record_id,
                    filename: oldAtt.filename,
                    mime_type: oldAtt.mime_type,
                    size_bytes: oldAtt.size_bytes,
                    chunk_count: chunks.length || 1
                };
                chunks.forEach((chunk, idx) => {
                    row[`base64_${idx + 1}`] = chunk;
                });
                return row;
            }
            // Remove old base64 field if chunks exist
            if (oldAtt.chunk_count && oldAtt.chunk_count > 0) {
                const { base64, ...rest } = oldAtt;
                return rest;
            }
            return oldAtt;
        });
        // Split base64 into chunks to avoid Excel 32767 character limit
        const newAT = state.attachments.map(a => {
            const base64 = a.base64 || '';
            const chunks = [];
            for (let i = 0; i < base64.length; i += MAX_CELL_LENGTH) {
                chunks.push(base64.substring(i, i + MAX_CELL_LENGTH));
            }
            const row = {
                record_id: state.id,
                filename: a.filename,
                mime_type: a.mime,
                size_bytes: a.size || (base64 ? Math.floor(base64.length * 3 / 4) : 0),
                chunk_count: chunks.length || 1
            };
            // Store each chunk in separate columns (base64_1, base64_2, etc.)
            chunks.forEach((chunk, idx) => {
                row[`base64_${idx + 1}`] = chunk;
            });
            // If no chunks, add empty base64_1
            if (chunks.length === 0) {
                row.base64_1 = '';
            }
            return row;
        });

        writeSheet(wb, 'Records', newRecs);
        writeSheet(wb, 'LineItems', [...otherLI, ...newLI]);
        writeSheet(wb, 'SubItems', [...otherSI, ...newSI]);
        writeSheet(wb, 'Payments', [...otherPayments, ...newPayments]);
        writeSheet(wb, 'Attachments', [...otherAT, ...newAT]);
        writeSheet(wb, 'Meta', [{ key: 'schema_version', value: '1.5' }, { key: 'exported_at_utc', value: new Date().toISOString() }]);
        
        return wb;
    }
    
    function sheetToJSON(wb, sheetName) {
        const ws = wb.Sheets[sheetName];
        if (!ws) return [];
        return XLSX.utils.sheet_to_json(ws, { defval: '' });
    }
    
    function loadRecordFromWorkbook(wb, recId) {
        const rec = sheetToJSON(wb, 'Records').find(x => String(x.id).trim() === String(recId).trim());
        if (!rec) {
            showNotification(`Record not found: ${recId}`, 'error');
            return;
        }
        lastWorkbook = wb; // Store the loaded workbook
        const payments = sheetToJSON(wb, 'Payments');
        const lineItems = sheetToJSON(wb, 'LineItems');
        const subItems = sheetToJSON(wb, 'SubItems');
        const attachments = sheetToJSON(wb, 'Attachments');

        const newState = getInitialState();
        newState.type = rec.type || 'Invoice';
        newState.id = rec.id || '';
        newState.number = rec.number || '';
        newState.status = rec.status || 'Draft';
        newState.date = rec.date || todayISO();
        newState.dueInDays = (rec.due_date && rec.date) ? Math.round(Math.max(0, (new Date(rec.due_date) - new Date(rec.date)) / 86400000)) : 15;
        
        newState.billTo = [rec.client_name, rec.client_company, [rec.client_email, rec.client_phone].filter(Boolean).join(' · '), rec.client_address].filter(Boolean).join('\n');
        newState.notes = rec.notes || '';
        newState.taxPct = toNum(rec.tax_percent);

        newState.payments = payments.filter(p => String(p.record_id).trim() === recId)
            .map(p => ({ date: p.date, amount: toNum(p.amount), method: p.method }))
            .sort((a,b) => new Date(a.date) - new Date(b.date));
        
        newState.adjustments.find(a => a.id === 'bond').pct = toNum(rec.bond_percent);
        newState.adjustments.find(a => a.id === 'bond').enabled = toNum(rec.bond_percent) > 0;
        newState.adjustments.find(a => a.id === 'oh').pct = toNum(rec.overhead_percent);
        newState.adjustments.find(a => a.id === 'oh').enabled = toNum(rec.overhead_percent) > 0;
        newState.adjustments.find(a => a.id === 'profit').pct = toNum(rec.profit_percent);
        newState.adjustments.find(a => a.id === 'profit').enabled = toNum(rec.profit_percent) > 0;

        const lines = lineItems.filter(x => String(x.record_id).trim() === recId).sort((a,b) => (a.line_no||0) - (b.line_no||0));
        newState.items = lines.map(L => {
            const subs = subItems.filter(s => String(s.record_id).trim() === recId && Number(s.line_no) === Number(L.line_no))
                                 .sort((a,b) => (a.subline_no||0) - (b.subline_no||0))
                                 .map(s => ({ desc: s.description, qty: s.qty, rate: s.rate }));
            return normalizeItem({ desc: L.description, qty: L.qty, rate: L.rate, usesSub: L.uses_subitems, subs });
        });

        newState.attachments = attachments.filter(a => String(a.record_id).trim() === recId).map(a => {
            // Reassemble base64 from chunks
            let base64 = '';
            const chunkCount = parseInt(a.chunk_count) || 1;
            for (let i = 1; i <= chunkCount; i++) {
                base64 += a[`base64_${i}`] || '';
            }
            // Fallback to old format if no chunks
            if (!base64 && a.base64) {
                base64 = a.base64;
            }
            return {
                filename: a.filename,
                mime: a.mime_type,
                base64: base64,
                size: a.size_bytes
            };
        });
        
        setStateAndRender(newState);
        showNotification(`Loaded record ${recId}`, 'success');
    }

    function writeSheet(wb, name, rows) {
        const ws = XLSX.utils.json_to_sheet(rows);
        wb.Sheets[name] = ws;
        if (!wb.SheetNames.includes(name)) {
            wb.SheetNames.push(name);
        }
    }

    // ---------- UI Helpers ----------
    let notificationTimeout;
    function showNotification(message, type = 'info') {
        const notification = $('#notification');
        const messageEl = $('#notification-message');

        messageEl.textContent = message;
        notification.classList.remove('bg-slate-800', 'bg-green-600', 'bg-red-600', 'bg-yellow-500');

        if (type === 'success') notification.classList.add('bg-green-600');
        else if (type === 'error') notification.classList.add('bg-red-600');
        else if (type === 'warn') notification.classList.add('bg-yellow-500');
        else notification.classList.add('bg-slate-800');

        notification.classList.remove('translate-x-[150%]');
        
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            notification.classList.add('translate-x-[150%]');
        }, 4000);
    }
    
    function setupDropdowns() {
        const statusOptions = ['Draft', 'Sent', 'Approved', 'Rejected', 'Paid'];
        const dueOptions = { '0': 'Due on receipt', '7': 'Net 7', '15': 'Net 15', '30': 'Net 30' };
        const docTypeOptions = ['Invoice', 'Estimate'];
        const stampOptions = ['None', 'Paid', 'Overdue', 'Void', 'Draft', 'Confidential'];

        $('#status').innerHTML = statusOptions.map(o => `<option>${o}</option>`).join('');
        $('#dueIn').innerHTML = Object.entries(dueOptions).map(([val, text]) => `<option value="${val}">${text}</option>`).join('');
        $('#docType').innerHTML = docTypeOptions.map(o => `<option>${o}</option>`).join('');
        $('#stampType').innerHTML = stampOptions.map(o => `<option>${o}</option>`).join('');
    }
    
    // ---------- Theme Management ----------
    function toggleTheme() {
        const html = document.documentElement;
        html.classList.toggle('dark');
        localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
        updateThemeIcons();
    }
    
    function updateThemeIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        $('#theme-icon-light').classList.toggle('hidden', isDark);
        $('#theme-icon-dark').classList.toggle('hidden', !isDark);
    }
    
    function applyInitialTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        updateThemeIcons();
    }

    // ---------- App Initialization ----------
    function init() {
        applyInitialTheme();
        loadCompanySettings(); // Load company settings first
        setupDropdowns();
        setupEventListeners();
        const savedLogo = localStorage.getItem('savedLogo');
        if (savedLogo) {
            state.logoDataUrl = savedLogo;
        }
        render(); // Initial render

        // Initialize Google Auth after a short delay to ensure scripts are loaded
        setTimeout(() => {
            initGoogleAuth();
        }, 500);

        showNotification('Welcome to the OAK Invoicing tool!', 'info');
    }

    init();
});
</script>
</body>
</html>

